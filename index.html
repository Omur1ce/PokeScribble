<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Daily PokéScribble — Guess the Pokémon</title>
<meta name="description" content="A daily Pokémon image guessing game with autocomplete.">
<style>
  :root{
    --bg:#3d5a98;
    --glass: rgba(255,255,255,.78);
    --text:#1a1a1a;
    --accent:#ef476f;
    --accent2:#118ab2;
    --ok:#0a8f4a;
    --err:#d90429;
  }
  html, body { height: 100%; }
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    color:var(--text); background:var(--bg);
  }
  .bg{
    position:fixed; inset:0;
    background:
      radial-gradient(1200px 600px at 10% -10%, rgba(255,255,255,.55), transparent 60%),
      radial-gradient(900px 500px at 105% 20%, rgba(255,255,255,.55), transparent 55%),
      linear-gradient(180deg, rgba(255,255,255,.35), rgba(255,255,255,.35));
    z-index:-1;
  }
  .wrap{ min-height:100%; display:grid; place-items:center; padding:5vh 16px; }
  .card{
    width:min(1100px, 96vw);
    background:var(--glass);
    border:1px solid rgba(0,0,0,.08);
    border-radius:20px;
    box-shadow:0 20px 60px rgba(0,0,0,.15);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    padding: clamp(18px, 4vw, 36px);
  }
  .title{ display:flex; gap:12px; align-items:center; margin:0 0 8px; text-transform:uppercase; letter-spacing:.02em; }
  .title b{ font-size: clamp(1.3rem, 3.6vw, 2.1rem); }
  .pokeball{ width:36px; height:36px; border-radius:50%; flex:0 0 auto;
    background:
      radial-gradient(circle at 50% 50%, #fff 0 7px, transparent 7px),
      linear-gradient(#ff3b3b 0 50%, #fff 50% 100%);
    border:3px solid #1a1a1a; box-shadow: inset 0 2px 0 rgba(0,0,0,.15), 0 6px 18px rgba(0,0,0,.15);
  }
  .sub{ margin:0 0 14px; color:#333; }
  .hr{ height:3px; border-radius:3px; background:linear-gradient(90deg, var(--accent), var(--accent2)); margin:10px 0 20px; }

  .meta{ display:flex; gap:12px; flex-wrap:wrap; margin-top:10px; color:#333; }
  .pill{ background:#0000000e; padding:6px 10px; border-radius:999px; }

  /* 3 daily puzzles */
  .grid{
    display:grid;
    grid-template-columns: 1fr;
    gap: 16px;
  }
  @media (min-width: 900px){
    .grid{ grid-template-columns: repeat(3, 1fr); }
  }

  .puzzle{
    background:#fff;
    border:1px solid rgba(0,0,0,.08);
    border-radius:16px;
    padding: 14px;
    box-shadow:0 8px 24px rgba(0,0,0,.06);
  }
  .imgbox{
    background:#fff;
    border:1px solid rgba(0,0,0,.08);
    border-radius:14px;
    padding:12px;
    display:grid;
    place-items:center;
    min-height:240px;
    position:relative;
    margin-bottom: 12px;
  }
  .imgbox img{
    max-width:100%;
    max-height:320px;
    object-fit:contain;
    filter: drop-shadow(0 6px 24px rgba(0,0,0,.12));
  }
  .tag{
    position:absolute; top:10px; left:10px;
    font-size:.85rem; background:#0000000f; padding:6px 10px; border-radius:999px;
  }
  .label{ font-weight:700; margin-bottom:8px; }
  .input-wrap{ position:relative; }
  input[type="text"]{
    width:100%;
    padding:12px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,.14);
    background:#fff;
    color:#111;
    font-size:1rem;
    outline:none;
  }
  input[type="text"]:focus{ border-color:var(--accent2); box-shadow:0 0 0 3px rgba(17,138,178,.20); }
  .msg{ min-height:1.25em; margin-top:10px; font-weight:700; }
  .ok{ color:var(--ok); } .err{ color:var(--err); }

  .ac-list{
    position:absolute; left:0; right:0; top:100%; z-index:20;
    margin-top:6px; max-height:220px; overflow:auto;
    background:#ffffff; border:1px solid rgba(0,0,0,.12); border-radius:12px;
    box-shadow:0 16px 40px rgba(0,0,0,.15);
  }
  .ac-item{ padding:10px 12px; cursor:pointer; display:flex; gap:8px; align-items:center; color:#111; }
  .ac-item:hover, .ac-item[aria-selected="true"]{ background:#f3f8ff; }
  .dex{ opacity:.7; font-variant-numeric:tabular-nums; min-width:3ch; }
  .hide{ display:none; }
</style>
</head>
<body>
<div class="bg"></div>
<div class="wrap">
  <main class="card">
    <h1 class="title">
      <span class="pokeball" aria-hidden="true"></span>
      <b>Daily PokéScribble</b>
      <span style="font-weight:400">— Guess the Pokémon</span>
    </h1>
    <p class="sub">Three scribbles a day! All scribbled by the awesome <strong>Chenipan</strong>.</p>
    <div class="hr" aria-hidden="true"></div>

    <div class="meta">
      <div class="pill">Next puzzles in: <span id="countdown">--:--:--</span></div>
      <div class="pill" id="todayTag"></div>
    </div>

    <section id="puzzles" class="grid" style="margin-top:16px;">
      <!-- 3 puzzles injected here -->
    </section>
  </main>
</div>

<script>
/* ====== Config ====== */
const SPRITE_EXT = "jpeg"; // change to "png" if your images are .png
const PUZZLES_PER_DAY = 3;

/* ====== Utilities ====== */
const msDay = 24*60*60*1000;
const normalize = s => s.toLowerCase().normalize("NFKD")
  .replace(/[\u0300-\u036f]/g,"")
  .replace(/[^a-z0-9]+/g,"")
  .trim();

function parseNamesTxt(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const rows = [];
  for (const line of lines){
    if (/^number\b/i.test(line) || /^name\b/i.test(line)) continue;
    const parts = line.split(/\s+/);
    const num = parts.shift();
    const name = parts.join(' ');
    if (num && name) rows.push({ num, name });
  }
  return rows;
}
function pad3(n){ return String(n).padStart(3,'0'); }

function spritePathFor(num){
  return `sprites/${pad3(num)}.${SPRITE_EXT}`;
}

function spriteExists(path) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => resolve(true);
    img.onerror = () => resolve(false);
    img.src = path + "?cache=" + Math.random();
  });
}

/* ====== Deterministic "random" daily picks ======
   - Not based on specific Pokémon number/date mapping
   - But deterministic per day so everyone gets same 3 for that day
   - Depends on dex length
*/
function getDayKeyLocal(){
  const d = new Date();
  d.setHours(0,0,0,0);
  return Math.floor(d.getTime()/msDay); // integer day number
}

// Tiny seeded PRNG (Mulberry32)
function mulberry32(seed){
  return function() {
    let t = seed += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  }
}

async function pickDailyPokemons(dex, count){
  const dayKey = getDayKeyLocal();
  const rng = mulberry32(dayKey ^ (dex.length * 2654435761)); // mix in dex length

  const picked = [];
  const usedIdx = new Set();
  let safety = 0;

  while (picked.length < count && safety < dex.length * 5){
    safety++;
    const idx = Math.floor(rng() * dex.length);
    if (usedIdx.has(idx)) continue;

    const mon = dex[idx];
    const path = spritePathFor(mon.num);
    const ok = await spriteExists(path);

    if (!ok) { usedIdx.add(idx); continue; }

    usedIdx.add(idx);
    picked.push(mon);
  }

  return picked;
}

/* ====== Countdown ====== */
function nextMidnightCountdown(){
  const now = new Date();
  const midnight = new Date(now);
  midnight.setHours(24,0,0,0);
  const diff = midnight - now;

  const h = Math.max(0, Math.floor(diff/3600000));
  const m = Math.max(0, Math.floor((diff%3600000)/60000));
  const s = Math.max(0, Math.floor((diff%60000)/1000));
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

/* ====== Autocomplete (your function) ====== */
function attachAutocomplete(input, list, options, onPick){
  let items = []; let activeIndex = -1;

  function close(){ list.classList.add('hide'); list.innerHTML=''; activeIndex=-1; }
  function open(){ list.classList.remove('hide'); }

  function render(){
    list.innerHTML = '';
    items.forEach((opt, idx)=>{
      const div = document.createElement('div');
      div.className = 'ac-item';
      div.setAttribute('role','option');
      div.setAttribute('aria-selected', idx===activeIndex ? 'true':'false');
      div.innerHTML = `<span class="dex">#${opt.num}</span><span>${opt.name}</span>`;
      div.addEventListener('mousedown', e=>{ e.preventDefault(); pick(idx); });
      list.appendChild(div);
    });
    items.length ? open() : close();
  }

  function filter(){
    const q = normalize(input.value);
    if (!q){ close(); return; }
    const starts = [], contains = [];
    for (const o of options){
      const n = normalize(o.name);
      if (n.startsWith(q)) starts.push(o);
      else if (n.includes(q)) contains.push(o);
    }
    items = [...starts, ...contains].slice(0, 8);
    activeIndex = items.length ? 0 : -1;
    render();
  }

  function pick(idx){
    const opt = items[idx]; if (!opt) return;
    input.value = opt.name; close(); onPick(opt.name);
  }

  input.addEventListener('input', filter);
  input.addEventListener('focus', filter);
  input.addEventListener('blur', ()=> setTimeout(close, 100));
  input.addEventListener('keydown', e=>{
    if (list.classList.contains('hide')) return;
    if (e.key==='ArrowDown'){ e.preventDefault(); if (activeIndex<items.length-1) activeIndex++; render(); }
    else if (e.key==='ArrowUp'){ e.preventDefault(); if (activeIndex>0) activeIndex--; render(); }
    else if (e.key==='Enter'){ e.preventDefault(); if (activeIndex>=0) pick(activeIndex); }
    else if (e.key==='Escape'){ close(); }
  });
}

/* ====== Render one puzzle card ====== */
function renderPuzzleCard(mon, index, dex){
  const el = document.createElement('div');
  el.className = 'puzzle';

  el.innerHTML = `
    <div class="imgbox">
      <div class="tag">Scribble ${index+1}</div>
      <img alt="Scribble ${index+1}" />
    </div>

    <div class="label">Your Guess</div>
    <div class="input-wrap">
      <input placeholder="Start typing a Pokémon…" autocomplete="off" />
      <div class="ac-list hide" role="listbox" aria-label="Pokémon suggestions"></div>
    </div>
    <div class="msg" aria-live="polite"></div>
  `;

  const img = el.querySelector('img');
  const input = el.querySelector('input');
  const list = el.querySelector('.ac-list');
  const msg = el.querySelector('.msg');

  img.src = spritePathFor(mon.num);
  img.alt = mon.name;

  function check(){
    const value = normalize(input.value);
    if (!value){ msg.textContent=''; msg.className='msg'; return; }
    const correct = normalize(mon.name) === value;
    msg.textContent = correct ? '✅ Correct!' : '❌ Try again';
    msg.className = 'msg ' + (correct ? 'ok' : 'err');
  }

  attachAutocomplete(input, list, dex, () => check());
  input.addEventListener('keydown', e => { if (e.key === 'Enter') check(); });
  input.addEventListener('change', check);

  return el;
}

/* ====== Boot ====== */
async function main(){
  const countdownEl = document.getElementById('countdown');
  const puzzlesEl = document.getElementById('puzzles');
  const todayTag = document.getElementById('todayTag');

  // Start countdown (fixed)
  countdownEl.textContent = nextMidnightCountdown();
  setInterval(() => {
    countdownEl.textContent = nextMidnightCountdown();
  }, 1000);

  // Date tag
  const todayStr = new Date().toLocaleDateString(undefined, { year:'numeric', month:'short', day:'2-digit' });
  todayTag.textContent = `Today: ${todayStr}`;

  // Load dex from names.txt
  let dex = [];
  try{
    const res = await fetch('names.txt', { cache: "no-store" });
    const text = await res.text();
    dex = parseNamesTxt(text);
  } catch(e){
    puzzlesEl.innerHTML = `<div class="puzzle"><div class="msg err">Could not load Pokédex (names.txt). Are you using a local server / GitHub Pages?</div></div>`;
    return;
  }

  if (!dex.length){
    puzzlesEl.innerHTML = `<div class="puzzle"><div class="msg err">Pokédex loaded but empty. Check names.txt format.</div></div>`;
    return;
  }

  // Pick 3 daily scribbles (random but deterministic for the day)
  const picks = await pickDailyPokemons(dex, PUZZLES_PER_DAY);

  if (picks.length < PUZZLES_PER_DAY){
    puzzlesEl.innerHTML = `<div class="puzzle"><div class="msg err">Not enough valid sprites found. Ensure sprites/NNN.${SPRITE_EXT} exists for many entries in names.txt.</div></div>`;
    return;
  }

  // Render 3 cards
  puzzlesEl.innerHTML = '';
  picks.forEach((mon, i) => puzzlesEl.appendChild(renderPuzzleCard(mon, i, dex)));
}

main();
</script>
</body>
</html>
